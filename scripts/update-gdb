#!/bin/bash -e

export LC_ALL=C

sudo=

[ -d sys-devel ] && cd sys-devel/gdb
[ -d ../sys-devel ] && cd ../sys-devel/gdb
if [ ! -e metadata.xml ] ; then
	echo "Run this in the gdb dir"
	exit 1
fi

export FEATURES="assume-digests -strict digest"

date

lynx -dump -nolist ftp://sources.redhat.com/pub/gdb/snapshots/current > list

snaps=$(grep gdb-weekly-'[[:digit:]]'.*.tar list | cut -d- -f3)

src=$(ls gdb-*.ebuild | sort | tail -n 1)
for s in ${snaps} "" ; do
	[[ ${s} == *.tar.* ]] || continue
	s=${s%.tar.*}
	dst="gdb-${s}.ebuild"
	[[ ! -e ${dst} ]] || continue
	echo "### found ${s}"
	cp ${src} ${dst}
	$sudo env GENTOO_MIRRORS=" " FEATURES="${FEATURES}" ebuild ${dst} fetch
done

rm -f list

$sudo ebuild ${src} manifest
